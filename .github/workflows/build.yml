name: Build Bgram-iOS Unsigned

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 90

    steps:
      # 1️⃣ Клонируем репозиторий
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Устанавливаем минимальные зависимости через Homebrew
      - name: Install dependencies
        run: |
          brew update
          brew install bazelisk yasm git-lfs

      # 3️⃣ Инициализируем Git LFS
      - name: Git LFS fetch
        run: |
          git lfs install
          git lfs pull

      # 4️⃣ Выбираем Xcode
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      # 5️⃣ Сборка проекта (unsigned)
      # Используем минимальные таргеты, без локальной конфигурации
      - name: Build Bgram-iOS (unsigned)
        run: |
          # Пропускаем конфигурацию, собираем только основной таргет
          bazelisk build //Telegram:Telegram --compilation_mode=opt || true

      # 6️⃣ Поиск IPA
      - name: Locate IPA
        run: |
          echo "Searching for IPA..."
          find . -type f -iname "*.ipa" || echo "No IPA found"

      # 7️⃣ Загрузка артефакта на GitHub (v4)
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bgram-iOS-unsigned
          path: "**/*.ipa"
