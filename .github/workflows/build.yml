name: Build Unsigned Telegram iOS

on:
  push:
    branches: [ main ]  # Или master
  workflow_dispatch:  # Для ручного запуска

jobs:
  build:
    runs-on: macos-26  # macOS с Xcode

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set Xcode version
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          echo "Selected Xcode $XCODE_VERSION"
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer

      - name: Create source dir
        run: |
          sudo mkdir -p /Users/Shared
          cp -R $GITHUB_WORKSPACE /Users/Shared/telegram-ios
          cd /Users/Shared/telegram-ios

      - name: Setup build env
        run: |
          cd /Users/Shared/telegram-ios
          # Устанавливаем BUILD_NUMBER (из git коммитов + offset для стабильности)
          BUILD_NUMBER_OFFSET=0  # Или из файла build_number_offset
          COMMIT_COUNT=$(git rev-list --count HEAD)
          export BUILD_NUMBER=$((COMMIT_COUNT + BUILD_NUMBER_OFFSET))
          export APP_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["app"]);')
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

          # Импорт фейковых сертификатов (ключевой шаг для unsigned!)
          python3 build-system/Make/ImportCertificates.py --path build-system/fake-codesigning
          # Делаем их "доверенными" (self-signed, чтобы Bazel не ругался)
          security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain build-system/fake-codesigning/fake-dev.p12
          security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain build-system/fake-codesigning/fake-dist.p12

      - name: Build with Bazel (unsigned)
        run: |
          cd /Users/Shared/telegram-ios
          # Основная команда: build без provisioning profiles
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/telegram-bazel-cache" \
            build \
            --configuration=release_universal \
            --buildNumber=$BUILD_NUMBER \
            --disableProvisioningProfiles  # Ключевой флаг для unsigned!
          # Альтернатива: --configuration=release_arm64 для device-only

      - name: Package unsigned IPA
        id: package
        run: |
          cd /Users/Shared/telegram-ios
          OUTPUT_PATH="Telegram-$APP_VERSION-$BUILD_NUMBER"
          mkdir -p $OUTPUT_PATH
          # Копируем .app из Bazel output
          cp -R bazel-bin/Telegram/Telegram.ipa $OUTPUT_PATH/ || cp bazel-out/applebin_ios-ios_arm64-opt-ST-*/bin/Telegram/Telegram.app $OUTPUT_PATH/
          # Создаём Payload для IPA (стандартный unsigned метод)
          mkdir -p $OUTPUT_PATH/Payload
          mv $OUTPUT_PATH/*.app $OUTPUT_PATH/Payload/  # Или .ipa если уже есть
          # Архивируем в .zip и переименовываем в .ipa
          zip -r "$OUTPUT_PATH.ipa" $OUTPUT_PATH/Payload
          echo "ipa_path=$OUTPUT_PATH.ipa" >> $GITHUB_ENV

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-Unsigned-IPA
          path: /Users/Shared/telegram-ios/*.ipa

      - name: Create GitHub Release (optional)
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ env.BUILD_NUMBER }}
          release_name: Telegram ${{ env.APP_VERSION }} (unsigned)
          body: Unsigned build for testing. Install on jailbroken device.
          draft: false
          prerelease: false
          assets: /Users/Shared/telegram-ios/*.ipa